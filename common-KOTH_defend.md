--------------------------------------------------
King of the Hill / Attack - Defence / Red team - Blue Team
--------------------------------------------------

### Firewall - IPtables
```bash
sudo iptables -A INPUT -p tcp --dport 22222 -j ACCEPT  # Allows SSH traffic - change SSH port below
sudo iptables -A INPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT # Allows established connections
sudo iptables -A INPUT -j DROP # Deny all other traffic
```

### Disable bash history
```bash
ln -sf /dev/null ~/.bash_history
```

### SSH connections
- modify the ssh config file
```bash
sudo nano /etc/ssh/sshd_config
```
```plain
Port 22222
PasswordAuthentication no
ChallengeResponseAuthentication no
PubkeyAuthentication yes
PermitRootLogin no
```
```bash
sudo systemctl restart sshd
```
- view ssh logs
```bash
sudo journalctl -u ssh
```
- accept authentication with "id_rsa" SSH keys only
```bash
# locally
ssh-keygen -t rsa
ssh-copy-id -i ~/.ssh/id_rsa.pub user@target_ip
```
```plain
# on remote machine, modify `/etc/ssh/sshd_config`
PasswordAuthentication no
ChallengeResponseAuthentication no
```
```bash
sudo systemctl restart sshd
```

### Redirect stdout and stderr of any following command to /dev/null
```bash
exec >/dev/null
```
- can be bypassed with the following
```bash
exec >/dev/tty
```

### Prevent users from seeing processes that do not belong to them
```bash
sudo mount -o remount,rw,hidepid=2 /proc
```
- create a group of users that bypass this restriction
```bash
proc /proc proc defaults,hidepid=2,gid=admin 0 0 
```

### Fail2ban
- automatically ban IP addresses that repeatedly fail to authenticate or perform suspicious activities
```bash
sudo apt-get install fail2ban
/etc/fail2ban/jail.local
```
```plain
[sshd]
enabled = true
port = 22222
filter = sshd
logpath = /var/log/auth.log
maxretry = 3
bantime = 86400
```

### Disable unused network protocols
```bash
sudo nano /etc/sysctl.conf
```
```plain
net.ipv6.conf.all.disable_ipv6 = 1
net.ipv6.conf.default.disable_ipv6 = 1
```

### Disable unnecessary services
```bash
systemctl list-unit-files --state=enabled
sudo systemctl disable <service-name>
```

### Install security updates
```bash
sudo apt-get update
sudo apt-get upgrade
```

### Enable auditing with auditd
```bash
sudo apt-get install auditd
sudo systemctl enable auditd
```

### Use Logwatch (or Logcheck) to monitor log files for suspicious activity 
```bash
sudo apt-get install logwatch
sudo nano /usr/share/logwatch/default.conf/logwatch.con
```
- monitor ssh login attemts in /var/log/auth.log
```plain
# Monitor SSH login attempts
LogFile = /var/log/auth.log
*Remove = root
*Remove = backup
*Remove = mail
*OnlyHosts = 192.168.1.0/24
*ApplyhttpDate
*ApplyStdDate
*Apply = /usr/share/logwatch/scripts/shared/apply-uudecode
*Apply = /usr/share/logwatch/scripts/shared/apply-mailto
*NoDetail = /etc/logwatch/conf/logwatch.conf
```
- run Logwatch and generate a report
```bash
sudo logwatch
```

### Use a file integrity monitoring tool
```bash
sudo apt-get install tripwire
sudo tripwire --init    # initialize the tripwire database
sudo tripwire --check   # check for changes
```

### View user activity
```bash
sudo last  # user login history
sudo last username
sudo w     # current users and their activities
sudo who
```

### Use an IDS/IPS
```bash
sudo apt-get install snort
sudo systemctl start snort
sudo tail -f /var/log/snort/alert
```

### View recently modified files
```bash
# created or modified in the last 5 days
find / -mtime -5 -o -ctime -5 2>/dev/null
```

### View world-writable files
```bash
find /dir -xdev -type d \( -perm -0002 -a ! -perm -1000 \) -print
```

### Kick a user off your machine
- first method
```bash
# replace username with actual user
# replace $tty with terminal name in `who` output (ex. `pts/2`) 
echo "Goodbye, kiddo!" | write $user $tty && sleep 10 && killall -u $user -HUP
```
- second method
```bash
# view who is logged in and the tty pid
who -u
# mock them before you kick them out
(echo "And now... you are gone" | write $user $tty) && sleep 10
# kill the tty pid
kill -9 $pid
```

